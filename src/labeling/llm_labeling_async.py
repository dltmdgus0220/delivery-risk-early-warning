import re
import argparse
import json
import os
import asyncio
import time
from typing import Any, List, Dict

import pandas as pd
from google import genai  # pip install -U google-genai


# --- 1. 프롬프트 생성 ---

def build_batch_prompt(texts: List[str], ratings: List[int]) -> str:
    # LLM이 실수없이 잘 이해할 수 있도록 "ID_1: (별점 5점) 맛있어요" 형식으로 묶음.
    combined_inputs = "\n".join([
        f"ID_{i+1}: (별점 {r}점) {t}" for i, (r, t) in enumerate(zip(ratings, texts))
    ])
    
    return f"""
너는 숙련된 고객 경험 분석가이자 데이터 라벨러다. 아래 가이드라인을 바탕으로 배달 앱 리뷰 {len(texts)}개를 분석하라.

### [분류 가이드라인]
1. 0 (없음): 긍정적 경험. 불만이 있더라도 재이용 의사가 높거나 단순 건의인 경우.
2. 1 (약함): 서비스에 실망했으나 "다음에는 잘해달라"는 개선 요구가 있거나, 단순 불평에 그친 경우.
3. 2 (강함): 재이용 거부 의사 표명("다시는 안 함", "삭제", "돈 아깝다") 또는 위생/태도 등 치명적 결함. 반복된 불만 표출 포함.

### [분류 규칙]
- **비꼬기 주의**: 별점은 낮으나 내용은 긍정적(예: "진짜 빨리 오네요ㅋㅋ")인 경우 문맥상 비꼬는 것(강함)으로 판단하고, 키워드는 실제 의미(예: "배달-지연")로 추출하라.
- **과거 경험 언급**: "저번에도 이러더니 이번에도 그러네요"처럼 반복된 불만이 보이면 즉시 '강함'으로 분류하라.

### [복합 감정 처리 가이드라인]
리뷰에 긍정과 부정이 섞여 있을 경우 아래의 '부정 우선순위'에 따라 라벨링하라.

1. **결정적 부정 (2: 강함)**: 
   - 서비스나 품질에 대한 칭찬이 있더라도 재이용 거부 의사, 치명적 결함, 반복 불만 중 하나라도 포함되는 경우. (예: "다시는 안 먹음", "돈 아깝다", "위생 불량", "태도 불량")
2. **부분적 부정 (1: 약함)**: 
   - 전반적으로 만족하나 특정 부분(배달, 요청사항 미이행, 가격 등)에 명확한 실망을 표현한 경우.
3. **단순 아쉬움 (0: 없음)**: 
   - 만족도가 높으며, 서비스 이탈로 이어질 가능성이 없는 가벼운 피드백.

### [제약 사항]
- 반드시 제공된 ID_1부터 ID_{len(texts)}까지 순서대로 누락 없이 라벨링하라.
- 결과는 반드시 마크다운 없이 JSON 리스트 형식으로만 출력하라.
- 입력 개수와 출력 결과의 개수가 반드시 일치해야 한다.

### [입력 데이터]
{combined_inputs}

### [출력 형식 및 예시]
[
  {{
    "id": 1,
    "churn_intent": "강함",
    "churn_intent_label": 2,
    "churn_intent_confidence": 0.9,
    "churn_intent_reason": "재이용 의사 없음을 명확히 밝히고 배달지연에 대한 문제를 반복적으로 경험하고 있음"
  }}
]
""".strip()

